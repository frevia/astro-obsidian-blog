---
// 分类索引页：列出所有分类及数量

import { getCollection } from "astro:content";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import getUniqueCategories from "@/utils/getUniqueCategories";
import getSortedPosts from "@/utils/getSortedPosts";
import { SITE } from "@/config";
import { getCategoryImageUrl } from "@/utils/categoryImages";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
let categories = getUniqueCategories(posts);

const categoryLatestPost = new Map<string, string>();
categories.forEach(({ categoryName }) => {
  const latestPost = sortedPosts.find(post => post.data.categories.includes(categoryName));
  if (latestPost) {
    categoryLatestPost.set(categoryName, latestPost.data.title);
  }
});
---

<Layout title={`分类 | ${SITE.title}`}>
  <Header />
  <Main pageTitle="分类" pageDesc="">
    <section class="space-y-6">
      <ul class="grid grid-cols-1 sm:grid-cols-2 gap-1" aria-label="分类列表">
        {
          categories.map(({ category, categoryName, count }, i) => (
            <li class={`categories-item ${i >= SITE.postPerIndex ? 'hidden' : ''}`}>
              <a href={`/categories/${category}`} aria-label={`查看 ${categoryName} 分类`} class="group block overflow-hidden relative">
                <div class="w-full overflow-hidden" style="aspect-ratio: 16 / 9;">
                  {
                    (getCategoryImageUrl(category) || getCategoryImageUrl(categoryName)) ? (
                      <img
                        src={getCategoryImageUrl(category) || getCategoryImageUrl(categoryName)}
                        alt={`${categoryName} 封面图`}
                        loading="lazy"
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    ) : (
                      <div class="w-full h-full bg-foreground/20" />
                    )
                  }
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                <div class="absolute bottom-0 left-0 right-0 p-4">
                  <span class="text-xs text-white/80 block mb-1" style={`view-transition-name: ${category}`}>
                    {categoryName}（{count}篇）
                  </span>
                  <h3 class="text-sm text-white leading-tight line-clamp-1">
                    {categoryLatestPost.get(categoryName) || categoryName}
                  </h3>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
      <div id="categories-sentinel" data-init={SITE.postPerIndex} data-chunk={SITE.postPerPage}></div>
    </section>
  </Main>
  <Footer />
</Layout>

<script is:inline src="/lazy-list.js"></script>
<script is:inline>
  function boot(){
    window.setupLazyList({
      sentinelId: 'categories-sentinel',
      itemSelector: '.categories-item',
      artalk: { enabled: false }
    });
  }
  document.addEventListener('astro:after-swap', () => { if (typeof window.setupLazyList === 'function') boot(); });
  document.addEventListener('astro:page-load', () => { if (typeof window.setupLazyList === 'function') boot(); });
</script>
