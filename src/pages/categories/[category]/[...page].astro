---
import { getCollection } from "astro:content";
import type { GetStaticPathsOptions } from "astro";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import getUniqueCategories from "@/utils/getUniqueCategories";
import getSortedPosts from "@/utils/getSortedPosts";
import { SITE } from "@/config";

// 生成分类页面的静态路径
export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection("blog");
  const categories = getUniqueCategories(posts);
  return categories.flatMap(({ category, categoryName }) => {
    const categoryPosts = getSortedPosts(
      posts.filter(post => (post.data as any).categories?.includes(categoryName))
    );
    return paginate(categoryPosts, {
      params: { category },
      props: { categoryName },
      pageSize: categoryPosts.length,
    });
  });
}

// const params = Astro.params; // not needed
// const { category } = params;
const { page, categoryName } = Astro.props;
---

<Layout title={`分类 ${categoryName} | ${SITE.title}`}>
  <Header />
  <Main pageTitle={`分类：${categoryName}`} pageDesc="">
    <ul class="category-posts-list">
      {
        page.data.map((data, i) => (
          <Card
            {...data}
            /* lazy-list helpers */
            itemClass="category-post-item"
            hidden={i >= SITE.postPerIndex}
          />
        ))
      }
    </ul>
    <div id="category-posts-sentinel" data-init={SITE.postPerIndex} data-chunk={SITE.postPerPage}></div>
  </Main>
  <Footer noMarginTop={true} />
</Layout>

<script is:inline src="/lazy-list.js"></script>
<script is:inline>
  function boot(){
    window.setupLazyList({
      sentinelId: 'category-posts-sentinel',
      itemSelector: '.category-post-item',
      artalk: {
        enabled: true,
        anchorSelector: 'a[href]',
        wrapperSelector: '.relative.block.pr-12',
      }
    });
  }

  document.addEventListener('astro:after-swap', () => { if (typeof window.setupLazyList === 'function') boot(); });
  document.addEventListener('astro:page-load', () => { if (typeof window.setupLazyList === 'function') boot(); });
</script>
